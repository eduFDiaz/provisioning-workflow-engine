name: phy_interface_activation
metadata:
    retry_policy:
      init_interval: 1
      backoff_coefficient: 2
      max_interval: 100
      max_attempts: 10
    version: 1.0
dependencies:
  - name: cpe_discovery
    version: 1.2.3
steps:     
  # - name: show_config
  #   hostname: sandbox-iosxe-latest-1.cisco.com
  #   configType: CLI
  #   config: |
  #     terminal length 0
  #     show running

  # - name: add_vrf
  #   hostname: sandbox-iosxe-latest-1.cisco.com
  #   configType: CLI
  #   config: |
  #     terminal length 0
  #     enable
  #     config t
  #     ip prefix-list Capgemini-DC1-Management seq 10 permit 192.168.187.0/28
  #     route-map Capgemini-VRF-IMPORT permit 10
  #     match ip address prefix-list Capgemini-DC1-Management
  #     exit
  #     route-map Capgemini-VRF-IMPORT permit 20
  #     match ip address prefix-list Capgemini-DC2-Management
  #     exit
  #     vrf definition VRF_Capgemini
  #     rd 300:1
  #     route-target export 300:4
  #     route-target import 300:4
  #     route-target import 300:3
  #     address-family ipv4
  #     import map Capgemini-VRF-IMPORT
  #     export map Capgemini-VRF-EXPORT
  #     exit-address-family
  #     end

  # - name: show_config_after
  #   hostname: sandbox-iosxe-latest-1.cisco.com
  #   configType: CLI
  #   config: |
  #     terminal length 0
  #     show running

  - name: Fetch_order_configs
    configType: REST
    request:
      url: http://localhost:8000/config/VNS_2358258
      method: GET
      headers:
        Accept: application/json
        Content-Type: application/json
    response:
      status_code: 200
      # json:
      #   $..interface[?(@.description =~ ".*MANAGEMENT.*")].name: interfaceName
      variables:
        vrf: json.$.vrf
        route_map: json.$.route-map
        ip_prefix_list: json.$.ip-prefix-list
    retry_policy:
        init_interval: 1
        backoff_coefficient: 2
        max_interval: 100
        max_attempts: 10

  - name: clean_up_vrf_config
    hostname: sandbox-iosxe-latest-1.cisco.com
    configType: CLI
    config: |
      terminal length 0
      enable
      config t
      no vrf definition VRF_Capgemini
      no route-map Capgemini-VRF-IMPORT
      exit

  - name: add_vrf_definition
    hostname: sandbox-iosxe-latest-1.cisco.com
    port: 830
    configType: NETCONF
    request:
      type: EDIT
      payload: |
        <config>
          <native xmlns="http://cisco.com/ns/yang/Cisco-IOS-XE-native">
            <vrf operation="merge">
              <definition>
                <name>{{vrf[0][0].name}}</name>
                <rd>{{vrf[0][0].rd}}</rd>
                <address-family>
                  <ipv4>
                    <export>
                      <map>{{vrf[0][0]['ipv4-export'][0]}}</map>
                    </export>
                    <import>
                      <map>{{vrf[0][0]['ipv4-import'][0]}}</map>
                    </import>
                  </ipv4>
                </address-family>
                <route-target>
                {% for rt in vrf[0][0]['rt-export'] %}
                  <export>
                    <asn-ip>{{rt}}</asn-ip>
                  </export>
                {% endfor %}
                {% for rt in vrf[0][0]['rt-import'] %}
                  <import>
                    <asn-ip>{{rt}}</asn-ip>
                  </import>
                {% endfor %}
                </route-target>
              </definition>
            </vrf>
          </native>
        </config>

  - name: add_prefix_lists
    hostname: sandbox-iosxe-latest-1.cisco.com
    port: 830
    configType: NETCONF
    request:
      type: EDIT
      payload: |
        <config>
          <native xmlns="http://cisco.com/ns/yang/Cisco-IOS-XE-native">
            <ip>
              <prefix-lists operation="merge">
              {% for pl in ip_prefix_list[0] %}
                <prefixes>
                  <name>{{pl['name']}}</name>
                  <no>{{pl['index']}}</no>
                  <action>{{pl['action']}}</action>
                  <ip>{{pl['prefix']}}</ip>
                </prefixes>
              {% endfor %}
              </prefix-lists>
              <prefix-list operation="merge">
              {% for pl in ip_prefix_list[0] %}
                <prefixes>
                  <name>{{pl['name']}}</name>
                  <seq>
                    <no>{{pl['index']}}</no>
                    <action>{{pl['action']}}</action>
                    <ip>{{pl['prefix']}}</ip>
                  </seq>
                </prefixes>
              {% endfor %}
              </prefix-list>
            </ip>
          </native>
        </config>

  - name: add_route_maps
    hostname: sandbox-iosxe-latest-1.cisco.com
    port: 830
    configType: NETCONF
    request:
      type: EDIT
      payload: |
        <config>
          <native xmlns="http://cisco.com/ns/yang/Cisco-IOS-XE-native">
          {% for rm in route_map[0] %}
            <route-map operation="merge">
              <name>{{rm['name']}}</name>
              {% for route in rm['match-list'] %}
              <route-map-without-order-seq xmlns="http://cisco.com/ns/yang/Cisco-IOS-XE-route-map">
                <seq_no>{{route['index']}}</seq_no>
                <operation>{{route['operation']}}</operation>
                <match>
                  <ip>
                    <address>
                      <prefix-list>{{route['prefix']}}</prefix-list>
                    </address>
                  </ip>
                </match>
              </route-map-without-order-seq>
              {% endfor %}
            </route-map>
          {% endfor %}
          </native>
        </config>

  # # - name: fetch_routing_instances_after_adding
  # #   hostname: sandbox-iosxe-latest-1.cisco.com
  # #   port: 830
  # #   configType: NETCONF
  # #   request:
  # #     type: FETCH
  # #     payload: |
  # #       <routing xmlns="urn:ietf:params:xml:ns:yang:ietf-routing">
  # #       </interfaces>